<!DOCTYPE html>
<html>
<head>
<title>Admin Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{min-height:100vh;background:linear-gradient(-45deg,#141e30,#243b55,#0f2027,#243b55);background-size:400% 400%;animation:gradientBG 15s ease infinite;color:white;overflow-x:hidden;}
@keyframes gradientBG{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}

.container{width:90%;max-width:1200px;margin:40px auto;}
h1{text-align:center;margin-bottom:30px;}

/* Tabs */
.tabs{display:flex;margin-bottom:20px;flex-wrap:wrap;}
.tabs button{flex:1;padding:12px;border:none;cursor:pointer;background:rgba(255,255,255,0.2);color:white;font-weight:600;transition:0.3s;border-radius:10px 10px 0 0;margin-right:5px;}
.tabs button.active{background:white;color:black;}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
.stat-card{background:rgba(255,255,255,0.15);padding:20px;border-radius:15px;backdrop-filter:blur(10px);text-align:center;transition:0.3s;}
.stat-card:hover{transform:scale(1.05);}

/* Cards */
.card{background:rgba(255,255,255,0.15);backdrop-filter:blur(15px);padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 0 20px rgba(0,0,0,0.3);transition:0.3s;}
.card:hover{transform:scale(1.02);}

/* Inputs */
input,select,textarea,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:none;outline:none;}
textarea{resize:none;}
button{background:#fff;color:black;font-weight:bold;cursor:pointer;transition:0.3s;}
button:hover{background:#ddd;}

/* Job & Application Cards */
.job, .application{background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;margin-top:10px;transition:0.3s;}
.job:hover, .application:hover{background:rgba(255,255,255,0.35);}
.delete-btn{background:red;color:white;margin-top:5px;padding:5px 8px;border:none;border-radius:6px;cursor:pointer;}
.status-btn{background:green;color:white;margin-top:5px;padding:5px 8px;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>

<body>
<div class="container">
<h1>Admin Portal</h1>

<!-- Tabs -->
<div class="tabs">
<button id="dashboardTab" class="active" onclick="showTab('dashboard')">Dashboard</button>
<button id="jobsTab" onclick="showTab('jobs')">Jobs</button>
<button id="applicationsTab" onclick="showTab('applications')">Applications</button>
</div>

<!-- DASHBOARD STATS -->
<div id="dashboard" class="tabContent">
<div class="stats">
  <div class="stat-card">
    <h2 id="totalJobs">0</h2>
    <p>Total Jobs</p>
  </div>
  <div class="stat-card">
    <h2 id="totalApplications">0</h2>
    <p>Total Applications</p>
  </div>
  <div class="stat-card">
    <h2 id="totalSelected">0</h2>
    <p>Selected Students</p>
  </div>
</div>
</div>

<!-- JOBS MANAGEMENT -->
<div id="jobs" class="tabContent card" style="display:none;">
<h2>Manage Jobs</h2>
<input id="title" placeholder="Job Title">
<input id="company" placeholder="Company Name">
<select id="category">
<option>On-Campus</option>
<option>Off-Campus</option>
<option>Defence</option>
<option>UPSC</option>
<option>TNPSC</option>
<option>SSC</option>
<option>RRB</option>
</select>
<textarea id="description" placeholder="Job Description"></textarea>
<input id="eligibility" placeholder="Eligibility Criteria">
<input type="date" id="last_date">
<button onclick="uploadJob()">Upload Job</button>

<h3 style="margin-top:20px;">Existing Jobs</h3>
<div id="jobList"></div>
</div>

<!-- APPLICATIONS MANAGEMENT -->
<div id="applications" class="tabContent card" style="display:none;">
<h2>All Student Applications</h2>
<div id="applicationList"></div>
</div>

</div>

<script>
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://mpcvctbrinkzdohjrpth.supabase.co",
  "sb_publishable_toAs6cvoLBqIpDEzVzabuA_KDUtaUvl"
);

/* TAB NAVIGATION */
function showTab(tab){
  document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
  document.getElementById(tab).style.display='block';
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tab+'Tab').classList.add('active');
}

/* -------------------- JOBS -------------------- */
async function uploadJob(){
  await supabaseClient.from('jobs').insert([{
    title:title.value,
    company:company.value,
    category:category.value,
    description:description.value,
    eligibility:eligibility.value,
    last_date:last_date.value
  }]);
  alert("Job Uploaded!");
  loadJobs();
  loadStats();
}

async function loadJobs(){
  const {data:jobs} = await supabaseClient.from('jobs').select('*');
  const jobList = document.getElementById("jobList");
  jobList.innerHTML = "";
  document.getElementById("totalJobs").innerText = jobs.length;

  for(const job of jobs){
    jobList.innerHTML += `
      <div class="job">
        <h3>${job.title}</h3>
        <p><b>Company:</b> ${job.company}</p>
        <p><b>Category:</b> ${job.category}</p>
        <p><b>Eligibility:</b> ${job.eligibility}</p>
        <p><b>Last Date:</b> ${job.last_date}</p>
        <button class="delete-btn" onclick="deleteJob('${job.id}')">Delete Job</button>
      </div>`;
  }
}

/* Delete Job */
async function deleteJob(id){
  await supabaseClient.from('jobs').delete().eq('id', id);
  loadJobs();
  loadStats();
}

/* -------------------- APPLICATIONS -------------------- */
async function loadApplications(){
 const {data:apps,error} = await supabaseClient
  .from('applications')
  .select('*, student_profiles(full_name, degree), jobs(title, company, eligibility, last_date)')
  .order('applied_at', {ascending:false});

  if(error){
    console.error("Error fetching applications:", error.message);
    return;
  }

  const container = document.getElementById("applicationList");
  container.innerHTML = "";
  let selectedCount = 0;

  if(apps.length === 0){
    container.innerHTML = "<p>No student applications found.</p>";
    document.getElementById("totalApplications").innerText = 0;
    document.getElementById("totalSelected").innerText = 0;
    return;
  }

  apps.forEach(app=>{
    if(app.status === "Selected") selectedCount++;

    container.innerHTML += `
      <div class="application">
        <p>
          <b>Student:</b> ${app.student_profiles ? app.student_profiles.full_name : "N/A"} |
          <b>Degree:</b> ${app.student_profiles ? app.student_profiles.degree : "N/A"} |
          <b>Job:</b> ${app.jobs ? app.jobs.title : "N/A"} (${app.jobs ? app.jobs.company : ""}) |
          <b>Status:</b> ${app.status}
        </p>
        <button class="status-btn" onclick="updateStatus('${app.id}','Selected')">Select</button>
        <button class="status-btn" style="background:orange;" onclick="updateStatus('${app.id}','Rejected')">Reject</button>
      </div>`;
  });

  document.getElementById("totalApplications").innerText = apps.length;
  document.getElementById("totalSelected").innerText = selectedCount;
}

/* Update application status */
async function updateStatus(appId, status){
  const {error} = await supabaseClient
    .from('applications')
    .update({status})
    .eq('id', appId);

  if(error){
    alert("Error updating status: "+error.message);
  } else {
    loadApplications();
  }
}

/* -------------------- STATS -------------------- */
async function loadStats(){
  const {data:apps} = await supabaseClient.from('applications').select('*');
  document.getElementById("totalApplications").innerText = apps.length;

  const selected = apps.filter(a => a.status === "Selected").length;
  document.getElementById("totalSelected").innerText = selected;
}

/* -------------------- INITIAL LOAD -------------------- */
loadJobs();
loadApplications();
loadStats();
</script>
</body>
</html>
