<!DOCTYPE html>
<html>
<head>
<title>Student Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{
  min-height:100vh;
  background:linear-gradient(-45deg,#141e30,#243b55,#0f2027,#243b55);
  background-size:400% 400%;
  animation:gradientBG 15s ease infinite;
  color:white;
}
@keyframes gradientBG{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}

.navbar{
  display:flex;justify-content:space-between;align-items:center;padding:15px 40px;background:rgba(0,0,0,0.3);backdrop-filter:blur(10px);
}
.navbar h2{font-weight:600;}
.navbar .user-info{display:flex;align-items:center;gap:20px;}
.navbar button{padding:8px 12px;border:none;border-radius:8px;background:#fff;color:black;font-weight:bold;cursor:pointer;transition:0.3s;}
.navbar button:hover{background:#ddd;}

.container{width:90%;max-width:1100px;margin:30px auto;}
h1{text-align:center;margin-bottom:20px;}

/* Tabs */
.tabs{display:flex;margin-bottom:20px;flex-wrap:wrap;}
.tabs button{flex:1;padding:12px;border:none;cursor:pointer;background:rgba(255,255,255,0.2);color:white;font-weight:600;transition:0.3s;border-radius:10px 10px 0 0;margin-right:5px;}
.tabs button.active{background:white;color:black;}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
.stat-card{background:rgba(255,255,255,0.15);padding:20px;border-radius:15px;backdrop-filter:blur(10px);text-align:center;transition:0.3s;}
.stat-card:hover{transform:scale(1.05);}

/* Cards */
.card{background:rgba(255,255,255,0.15);backdrop-filter:blur(15px);padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:0 0 20px rgba(0,0,0,0.3);transition:0.3s;}
.card:hover{transform:scale(1.02);}

/* Inputs */
input,select,textarea,button{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:none;outline:none;}
textarea{resize:none;}
button{background:#fff;color:black;font-weight:bold;cursor:pointer;transition:0.3s;}
button:hover{background:#ddd;}

/* Job & Application Cards */
.job, .application{background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;margin-top:10px;transition:0.3s;}
.job:hover, .application:hover{background:rgba(255,255,255,0.35);}
.status-btn{background:green;color:white;margin-top:5px;padding:5px 8px;border:none;border-radius:6px;cursor:pointer;}
.cancel-btn{background:red;color:white;margin-top:5px;padding:5px 8px;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
  <h2>Student Portal</h2>
  <div class="user-info">
    <span id="studentName">Welcome, Student</span>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">
<!-- Dashboard Stats -->
<div class="stats">
  <div class="stat-card">
    <h2 id="totalJobs">0</h2>
    <p>Total Jobs Available</p>
  </div>
  <div class="stat-card">
    <h2 id="totalApplied">0</h2>
    <p>My Applications</p>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button id="profileTab" class="active" onclick="showTab('profile')">Profile</button>
  <button id="jobsTab" onclick="showTab('jobs')">Available Jobs</button>
  <button id="applicationsTab" onclick="showTab('applications')">My Applications</button>
</div>

<!-- PROFILE -->
<div id="profile" class="tabContent card">
<h2>Profile</h2>
<input id="full_name" placeholder="Full Name">
<input id="degree" placeholder="Degree">
<input id="department" placeholder="Department">
<input id="cgpa" placeholder="CGPA">
<textarea id="skills" placeholder="Skills"></textarea>
<button onclick="saveProfile()">Save / Update Profile</button>
</div>

<!-- JOBS -->
<div id="jobs" class="tabContent card" style="display:none;">
<h2>Available Jobs</h2>
<div id="jobList"></div>
</div>

<!-- APPLICATIONS -->
<div id="applications" class="tabContent card" style="display:none;">
<h2>My Applications</h2>
<div id="myApplications"></div>
</div>

</div>

<script>
const { createClient } = supabase;
const supabaseClient = createClient(
  "https://mpcvctbrinkzdohjrpth.supabase.co",
  "sb_publishable_toAs6cvoLBqIpDEzVzabuA_KDUtaUvl"
);

const user = JSON.parse(sessionStorage.getItem("user"));
let profileId = null;

// Set student name in navbar
document.getElementById("studentName").innerText = `Welcome, ${user.email}`;

/* -------------------- LOGOUT -------------------- */
function logout(){
  sessionStorage.removeItem("user");
  window.location = "index.html"; // your login page
}

/* -------------------- TABS -------------------- */
function showTab(tab){
  document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
  document.getElementById(tab).style.display='block';
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tab+'Tab').classList.add('active');
}

/* -------------------- PROFILE -------------------- */
async function loadProfile(){
  const {data: profile} = await supabaseClient.from('student_profiles')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if(profile){
    profileId = profile.id;
    document.getElementById("full_name").value = profile.full_name || "";
    document.getElementById("degree").value = profile.degree || "";
    document.getElementById("department").value = profile.department || "";
    document.getElementById("cgpa").value = profile.cgpa || "";
    document.getElementById("skills").value = profile.skills || "";
  }
}

async function saveProfile(){
  const full_name = document.getElementById("full_name").value;
  const degree = document.getElementById("degree").value;
  const department = document.getElementById("department").value;
  const cgpa = document.getElementById("cgpa").value;
  const skills = document.getElementById("skills").value;

  if(profileId){
    await supabaseClient.from('student_profiles')
      .update({ full_name, degree, department, cgpa, skills })
      .eq('id', profileId);
    alert("Profile updated!");
  } else {
    const { data, error } = await supabaseClient.from('student_profiles').insert([{
      user_id: user.id,
      full_name, degree, department, cgpa, skills
    }]).select().single();
    if(error) alert("Error creating profile: "+error.message);
    else profileId = data.id;
    alert("Profile created!");
  }
  loadProfile();
  loadJobs();
}

/* -------------------- JOBS -------------------- */
async function loadJobs(){
  const {data: jobs} = await supabaseClient.from('jobs').select('*');
  const container = document.getElementById("jobList");
  container.innerHTML = "";
  document.getElementById("totalJobs").innerText = jobs.length;

  jobs.forEach(job=>{
    container.innerHTML += `
      <div class="job">
        <h3>${job.title}</h3>
        <p><b>Company:</b> ${job.company}</p>
        <p><b>Eligibility:</b> ${job.eligibility}</p>
        <button onclick="applyJob('${job.id}')">Apply Job</button>
      </div>`;
  });

  loadMyApplications();
}

/* -------------------- APPLY JOB -------------------- */
async function applyJob(jobId){
  if(!profileId){ alert("Please save your profile first!"); return; }

  const { data: existing } = await supabaseClient.from('applications')
    .select('*')
    .eq('student_id', profileId)
    .eq('job_id', jobId)
    .single();

  if(existing){ alert("You already applied for this job."); return; }

  const { error } = await supabaseClient.from('applications').insert([{
    student_id: profileId,
    job_id: jobId,
    status: "Applied"
  }]);

  if(error) alert("Error applying: "+error.message);
  else { alert("Application submitted!"); loadMyApplications(); }
}

/* -------------------- MY APPLICATIONS -------------------- */
async function loadMyApplications(){
  if(!profileId) return;
  const {data: apps} = await supabaseClient.from('applications')
    .select('*, jobs(title, company)')
    .eq('student_id', profileId)
    .order('applied_at', {ascending:false});

  const container = document.getElementById("myApplications");
  container.innerHTML = "";
  document.getElementById("totalApplied").innerText = apps.length;

  if(!apps || apps.length === 0){
    container.innerHTML = "<p>No applications yet.</p>";
    return;
  }

  apps.forEach(app=>{
    container.innerHTML += `
      <div class="application">
        <p><b>Job:</b> ${app.jobs.title} | <b>Company:</b> ${app.jobs.company} | <b>Status:</b> ${app.status}</p>
        <button class="cancel-btn" onclick="cancelApplication('${app.id}')">Cancel Application</button>
      </div>`;
  });
}

/* -------------------- CANCEL APPLICATION -------------------- */
async function cancelApplication(appId){
  const confirmDelete = confirm("Are you sure you want to cancel this application?");
  if(!confirmDelete) return;

  const { error } = await supabaseClient.from('applications').delete()
    .eq('id', appId);

  if(error) alert("Error cancelling: "+error.message);
  else { alert("Application cancelled."); loadMyApplications(); }
}

/* -------------------- INITIAL LOAD -------------------- */
loadProfile();
loadJobs();

</script>
</body>
</html>
